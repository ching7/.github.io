<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FastDFS(分布式文件系统) | chenyanan の blog</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/master/icon/ico-pig.png">
    <meta name="description" content="学习最好的时间就是现在">
    <link rel="preload" href="/master/assets/css/0.styles.987710d3.css" as="style"><link rel="preload" href="/master/assets/js/app.2082b23a.js" as="script"><link rel="preload" href="/master/assets/js/2.926fc16b.js" as="script"><link rel="preload" href="/master/assets/js/6.5babb80d.js" as="script"><link rel="prefetch" href="/master/assets/js/10.5a0e9bef.js"><link rel="prefetch" href="/master/assets/js/11.8dc6e519.js"><link rel="prefetch" href="/master/assets/js/3.73bee7b8.js"><link rel="prefetch" href="/master/assets/js/4.200ee988.js"><link rel="prefetch" href="/master/assets/js/5.c23ae111.js"><link rel="prefetch" href="/master/assets/js/7.94c53387.js"><link rel="prefetch" href="/master/assets/js/8.5914f281.js"><link rel="prefetch" href="/master/assets/js/9.5b4c3f01.js">
    <link rel="stylesheet" href="/master/assets/css/0.styles.987710d3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/master/" class="home-link router-link-active"><!----> <span class="site-name">chenyanan の blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/master/00.mydocslist/" class="nav-link">
  我的工程
</a></div><div class="nav-item"><a href="/master/01.dev/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/master/02.front/" class="nav-link">
  前端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/ching7" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/master/00.mydocslist/" class="nav-link">
  我的工程
</a></div><div class="nav-item"><a href="/master/01.dev/" class="nav-link router-link-active">
  后端
</a></div><div class="nav-item"><a href="/master/02.front/" class="nav-link">
  前端
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/ching7" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nginx基础入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>FastDFS安装和使用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html" aria-current="page" class="active sidebar-link">FastDFS(分布式文件系统)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_1-什么是fastdfs" class="sidebar-link">1  什么是FastDFS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_1-1-简介" class="sidebar-link">1.1  简介</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_1-2-工作原理" class="sidebar-link">1.2  工作原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_2-fastdfs入门" class="sidebar-link">2 FastDFS入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_2-1-fastdfs安装配置-tracker" class="sidebar-link">2.1 FastDFS安装配置(tracker)</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_2-2-fastdfs安装配置-storage" class="sidebar-link">2.2 FastDFS安装配置(storage)</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_2-3-测试fastdfs是否安装成功" class="sidebar-link">2.3 测试FastDFS是否安装成功</a></li></ul></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_3-springboot整合fastdfs实现文件上传下载测试" class="sidebar-link">3 SpringBoot整合FastDFS实现文件上传下载测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_3-1-环境搭建" class="sidebar-link">3.1 环境搭建</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_3-2-文件上传、查询、下载" class="sidebar-link">3.2 文件上传、查询、下载</a></li></ul></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-文件服务案例" class="sidebar-link">4 文件服务案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-1-需求" class="sidebar-link">4.1 需求</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-2-安装-fastdfs、nginx" class="sidebar-link">4.2 安装 FastDFS、Nginx</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-3-通过http访问fastdfs图片" class="sidebar-link">4.3 通过HTTP访问FastDFS图片</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-4-安装-fastdht实现文件去重处理" class="sidebar-link">4.4 安装 FastDHT实现文件去重处理</a></li><li class="sidebar-sub-header"><a href="/master/01.dev/10.fastdfs/fastdfsStudy.html#_4-5-常见错误" class="sidebar-link">4.5 常见错误</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="fastdfs-分布式文件系统"><a href="#fastdfs-分布式文件系统" class="header-anchor">#</a> FastDFS(分布式文件系统)</h1> <h2 id="_1-什么是fastdfs"><a href="#_1-什么是fastdfs" class="header-anchor">#</a> 1  什么是FastDFS</h2> <h3 id="_1-1-简介"><a href="#_1-1-简介" class="header-anchor">#</a> 1.1  简介</h3> <p><code>FastDFS</code>是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。<code>FastDFS</code>专为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用<code>FastDFS</code>很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。</p> <p>为什么要使用<code>FastDFS</code>呢？</p> <p>已有的的<code>NFS</code>、<code>GFS</code>都是通用的分布式文件系统，通用的分布式文件系统的优点的是开发体验好，但是系统复杂性高、性能一般，而专用的分布式文件系统虽然开发体验性差，但是系统复杂性低并且性能高。</p> <p><code>FastDFS</code>非常适合存储图片等那些小文件，<code>FastDFS</code>不对文件进行分块，所以它就没有分块合并的开销，<code>FastDFS</code>网络通信采用<code>socket</code>，通信速度很快。</p> <h3 id="_1-2-工作原理"><a href="#_1-2-工作原理" class="header-anchor">#</a> 1.2  工作原理</h3> <h4 id="_1-2-1-fastdsf架构"><a href="#_1-2-1-fastdsf架构" class="header-anchor">#</a> 1.2.1 <code>FastDSF</code>架构</h4> <p><img src="/image/fastdfs.jpg" alt=""></p> <p><code>FastDFS</code>架构包括 <code>Tracker server</code>和<code>Storag eserver</code>。客户端请求<code>Tracker server</code>进行文件上传、下载，通过<code>Tracker server</code>调度最终由<code>Storage server</code>完成文件上传和下载。</p> <ul><li><p>Tracker</p> <p><code>Tracker Server</code>作用是负载均衡和调度，通过<code>Tracker server</code>在文件上传时可以根据一些策略找到<code>Storage server</code>提供文件上传服务。可以将<code>Tracker</code>称为追踪服务器或调度服务器。</p> <p><code>Tracker server</code>更像一个管理指挥员，管理<code>Storage server</code>，协调客户机将文件上传到<code>Storage Server</code></p> <p><code>FastDFS</code>集群中的<code>Tracker server</code>可以有多台，<code>Tracker server</code>之间是相互平等关系同时提供服务，<code>Tracker server</code>不存在单点故障。客户端请求<code>racker server</code>采用轮询方式，如果请求的<code>tracker</code>无法提供服务则换另一个<code>tracker</code>。</p></li> <li><p>Storage</p> <p><code>Storage Server</code>作用是文件存储，客户端上传的文件最终存储在<code>Storage</code>服务器上，<code>Storage server</code>没有实现自己的文件系统而是使用操作系统的文件系统来管理文件。可以将<code>storage</code>称为存储服务器。</p> <p><code>Storage</code>集群采用了分组存储方式。<code>storage</code>集群由一个或多个组构成，集群存储总容量为集群中所有组的存储容量之和。一个组由一台或多台存储服务器组成，组内的<code>Storage server</code>之间是平等关系，不同组的<code>Storage server</code>之间不会相互通信，同组内的<code>Storage server</code>之间会相互连接进行文件同步，从而保证同组内每个<code>storage</code>上的文件完
全一致的。一个组的存储容量为该组内存储服务器容量最小的那个，由此可见组内存储服务器的软硬件配置最好是一致的。</p> <p>采用分组存储方式的好处是灵活、可控性较强。比如上传文件时，可以由客户端直接指定上传到的组也可以由<code>tracker</code>进行调度选择。一个分组的存储服务器访问压力较大时，可以在该组增加存储服务器来扩充服务能力（纵向扩容）。当系统容量不足时，可以增加组来扩充存储容量（横向扩容）。</p></li> <li><p><code>Storage</code>状态收集</p> <p><code>Storage server</code>会连接集群中所有的<code>Tracker server</code>，定时向他们报告自己的状态，包括磁盘剩余空间、文件同步状况、文件上传下载次数等统计信息。</p></li></ul> <h4 id="_1-2-2-文件上传流程"><a href="#_1-2-2-文件上传流程" class="header-anchor">#</a> 1.2.2 文件上传流程</h4> <p><img src="/image/fastdfs1.jpg" alt="fastdfs上传流程"></p> <p>客户端上传文件后存储服务器将文件ID返回给客户端，此文件ID用于以后访问该文件的索引信息。文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code>group1/M00/00/00/wKjRgF3PPvOAOF7HAAFl33KnvNs832.jpg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>组名：文件上传后所在的<code>storage</code>组名称，在文件上传成功后有<code>storage</code>服务器返回，需要客户端自行保存。</li> <li>虚拟磁盘路径：<code>storage</code>配置的虚拟路径，与磁盘选项<code>store_path*</code>对应。如果配置了<code>store_path0</code>则是<code>M00</code>，如果配置了<code>store_path1</code>则是<code>M01</code>，以此类推。</li> <li>数据两级目录：<code>storage</code>服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件</li> <li>文件名：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器IP地址、文件创
建时间戳、文件大小、随机数和文件拓展名等信息。</li></ul> <h4 id="_1-2-3-文件下载流程"><a href="#_1-2-3-文件下载流程" class="header-anchor">#</a> 1.2.3 文件下载流程</h4> <p>tracker根据请求的文件路径即文件ID 来快速定义文件。</p> <p><img src="/image/fastdfs2.jpg" alt="fastdfs下载流程"></p> <p>比如请求下边的文件：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code>group1/M00/00/00/wKjRgF3PPvOAOF7HAAFl33KnvNs832.jpg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>通过组名<code>tracker</code>能够很快的定位到客户端需要访问的存储服务器组是<code>group1</code>，并选择合适的存储服务器提供客户端访问。</li> <li>存储服务器根据“文件存储虚拟磁盘路径”和“数据文件两级目录”可以很快定位到文件所在目录，并根据文件名找到
客户端需要访问的文件。</li></ul> <h2 id="_2-fastdfs入门"><a href="#_2-fastdfs入门" class="header-anchor">#</a> 2 FastDFS入门</h2> <h3 id="_2-1-fastdfs安装配置-tracker"><a href="#_2-1-fastdfs安装配置-tracker" class="header-anchor">#</a> 2.1 FastDFS安装配置(tracker)</h3> <p>注：本次之安装一台tracker、storage,且都在同一台机器上、方便调试。有兴趣的可以拓展成分布式</p> <h4 id="_2-1-1-安装条件"><a href="#_2-1-1-安装条件" class="header-anchor">#</a> 2.1.1 安装条件</h4> <ul><li>需要一台<code>CentOS7</code>虚拟机</li> <li>下载<code>FastDFS</code>安装包，地址：https://github.com/happyfish100/FastDFS ，本文档使用<code>FastDFS_v5.05.tar.gz</code></li></ul> <h4 id="_2-1-2-准备安装环境"><a href="#_2-1-2-准备安装环境" class="header-anchor">#</a> 2.1.2 准备安装环境</h4> <ul><li><p><code>FastDFS</code>是<code>C语言</code>开发，编译依赖<code>gcc</code>环境，安装 <code>gcc</code></p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>yum -y install gcc-c++
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>依赖依赖<code>libevent</code>库</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>yum -y install libevent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>libfastcommon</code>是<code>FastDFS</code>官方提供的，<code>libfastcommon</code>包含了<code>FastDFS</code>运行所需要的一些基础库。本文档使用的是<code>libfastcommonV1.0.7.tar.gz</code>,下载地址：https://github.com/happyfish100/libfastcommon/releases</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 将libfastcommonV1.0.7.tar.gz拷贝至/usr/local/下</span>
cd /usr/local
tar -zxvf libfastcommonV1.<span class="token number">0.7</span>.tar.gz
cd libfastcommon-<span class="token number">1.0.7</span>
./make.sh
./make.sh install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><strong>注意：<code>libfastcommon</code>安装好后会自动将库文件拷贝至<code>/usr/lib64</code>下，由于<code>FastDFS</code>程序引用<code>usr/lib</code>目录所以需要将<code>/usr/lib64</code>下的库文件拷贝至/<code>usr/lib</code>下。</strong></p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 这里要根据linux 32还是64位的实际调整</span>
cp /usr/lib64/libfastcommon.so /usr/lib/libfastcommon.so
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h4 id="_2-1-3-安装fastdfs"><a href="#_2-1-3-安装fastdfs" class="header-anchor">#</a> 2.1.3 安装FastDFS</h4> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 将FastDFS_v5.05.tar.gz拷贝至/usr/local/下</span>

tar -zxvf FastDFS_v5.<span class="token number">05</span>.tar.gz

cd FastDFS

./make.sh
./make.sh install

<span class="token comment"># 安装成功将安装目录下的conf下的文件拷贝到/etc/fdfs/下。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2-1-4-配置fastdfs-tracker"><a href="#_2-1-4-配置fastdfs-tracker" class="header-anchor">#</a> 2.1.4 配置FastDFS(tracker)</h4> <p>安装成功后进入<code>/etc/fdfs</code>目录</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>
<span class="token comment"># 拷贝一份新的tracker配置文件：</span>
cp tracker.conf.sample tracker.conf

<span class="token comment"># 修改tracker.conf</span>
vi tracker.conf
<span class="token comment"># base_path=/home/yuqing/FastDFS   </span>
<span class="token comment"># 改为：（根据个人具体情况调整）</span>
<span class="token comment"># base_path=/home/FastDFS</span>
<span class="token comment"># 配置http端口：</span>
http.server_port=<span class="token number">80</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_2-1-5-启动tracker"><a href="#_2-1-5-启动tracker" class="header-anchor">#</a> 2.1.5 启动Tracker</h4> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 注意控制台的打印信息（注意启动顺序-tracker-storage）</span>
/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-2-fastdfs安装配置-storage"><a href="#_2-2-fastdfs安装配置-storage" class="header-anchor">#</a> 2.2 FastDFS安装配置(storage)</h3> <h4 id="_2-2-1-安装过程"><a href="#_2-2-1-安装过程" class="header-anchor">#</a> 2.2.1 安装过程</h4> <p>同 <code>Tracker</code></p> <h4 id="_2-2-2-配置fastdfs-storage"><a href="#_2-2-2-配置fastdfs-storage" class="header-anchor">#</a> 2.2.2 配置FastDFS(Storage)</h4> <p>安装成功后进入<code>/etc/fdfs</code>目录</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 拷贝一份新的storage配置文件：</span>
cp storage.conf.sample storage.conf

<span class="token comment"># 修改storage.conf</span>
vi storage.conf
<span class="token comment"># group_name=group1</span>
<span class="token comment"># base_path=/home/yuqing/FastDFS 改为：base_path=/home/FastDFS（根据个人具体情况调整）</span>
<span class="token comment"># store_path0=/home/yuqing/FastDFS 改为：store_path0=/home/FastDFS/fdfs_storage（根据个人具体情况调整）</span>
<span class="token comment">#如果有多个挂载磁盘则定义多个store_path，如下（根据个人具体情况调整）</span>
<span class="token comment">#store_path1=.....</span>
<span class="token comment">#store_path2=......</span>
tracker_server=<span class="token number">192.168.101.3</span>:<span class="token number">22122</span>   <span class="token comment">#配置tracker服务器:IP</span>
<span class="token comment">#如果有多个则配置多个tracker</span>
tracker_server=<span class="token number">192.168.101.4</span>:<span class="token number">22122</span>

<span class="token comment">#配置http端口</span>
http.server_port=<span class="token number">80</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_2-2-3-启动storage"><a href="#_2-2-3-启动storage" class="header-anchor">#</a> 2.2.3 启动Storage</h4> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 注意控制台的打印信息（注意启动顺序-tracker-storage）</span>
/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-3-测试fastdfs是否安装成功"><a href="#_2-3-测试fastdfs是否安装成功" class="header-anchor">#</a> 2.3 测试FastDFS是否安装成功</h3> <h4 id="_2-3-1-上传图片测试"><a href="#_2-3-1-上传图片测试" class="header-anchor">#</a> 2.3.1 上传图片测试</h4> <p><code>FastDFS</code>安装成功可通过<code>/usr/bin/fdfs_test</code>测试上传、下载等操作。</p> <p>修改<code>/etc/fdfs/client.conf</code></p> <p><code>tracker_server</code>根据自己部署虚拟机的情况/配置</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 拷贝一份新的client配置文件：</span>
cp client.conf.sample client.conf

<span class="token comment"># 修改配置文件</span>
vi client.conf
<span class="token comment"># base_path=/home/fastdfs</span>
<span class="token comment"># tracker_server=192.168.101.3:22122</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用格式：</p> <p><code>/usr/bin/fdfs_test</code>客户端配置文件地址  <code>upload</code> 上传文件</p> <p>比如将<code>/home</code>下的图片上传到<code>FastDFS</code>中：</p> <div class="language-cma line-numbers-mode"><pre class="language-text"><code>/usr/bin/fdfs_test /etc/fdfs/client.conf upload /home/tomcat.png
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>看到如下日志：</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>This is FastDFS client test program v5.<span class="token number">05</span>

<span class="token function">Copyright</span> <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2008</span>, Happy Fish / YuQing

FastDFS may be copied only under the terms of the GNU General
Public License V3, which may be found in the FastDFS source kit.
Please visit the FastDFS Home Page http://www.csource.org/ 
for more detail.

[<span class="token number">2019</span>-<span class="token number">11</span>-<span class="token number">18</span> <span class="token number">22</span>:<span class="token number">56</span>:<span class="token number">28</span>] DEBUG - base_path=/home/chenyn/fastdfs/FastDFS, connect_timeout=<span class="token number">30</span>, network_timeout=<span class="token number">60</span>, tracker_server_count=<span class="token number">1</span>, anti_steal_token=<span class="token number">0</span>, anti_steal_secret_key length=<span class="token number">0</span>, use_connection_pool=<span class="token number">0</span>, g_connection_pool_max_idle_time=3600s, use_storage_id=<span class="token number">0</span>, storage server id count: <span class="token number">0</span>

tracker_query_storage_store_list_without_group: 
	server <span class="token number">1</span>. group_name=, ip_addr=<span class="token number">192.168.127.128</span>, port=<span class="token number">23000</span>

group_name=group1, ip_addr=<span class="token number">192.168.127.128</span>, port=<span class="token number">23000</span>
storage_upload_by_filename
group_name=group1, remote_filename=M00/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641.png
source ip address: <span class="token number">192.168.127.128</span>
file timestamp=<span class="token number">2019</span>-<span class="token number">11</span>-<span class="token number">18</span> <span class="token number">22</span>:<span class="token number">56</span>:<span class="token number">28</span>
file size=<span class="token number">26013</span>
file crc32=<span class="token number">2517038323</span>
example file url: http://<span class="token number">192.168.127.128</span>/group1/M00/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641.png
storage_upload_slave_by_filename
group_name=group1, remote_filename=M00/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641_big.png
source ip address: <span class="token number">192.168.127.128</span>
file timestamp=<span class="token number">2019</span>-<span class="token number">11</span>-<span class="token number">18</span> <span class="token number">22</span>:<span class="token number">56</span>:<span class="token number">29</span>
file size=<span class="token number">26013</span>
file crc32=<span class="token number">2517038323</span>
example file url: http://<span class="token number">192.168.127.128</span>/group1/M00/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641_big.png
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>恭喜你成功了🙂~</p> <h4 id="_2-3-2-下载图片"><a href="#_2-3-2-下载图片" class="header-anchor">#</a> 2.3.2 下载图片</h4> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>http://<span class="token number">192.168.127.128</span>/group1/M00/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641_big.png
<span class="token comment"># 此路径就是文件的下载路径 对应storage服务器上的</span>
/home/chenyn/fastdfs/FastDFS/storage/data/<span class="token number">00</span>/<span class="token number">00</span>/wKh_gF3SsRyAJg6iAABlnZYG9PM641_big.png文件。
<span class="token comment"># 由于现在还没有和nginx整合无法使用http下载。待新增</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_3-springboot整合fastdfs实现文件上传下载测试"><a href="#_3-springboot整合fastdfs实现文件上传下载测试" class="header-anchor">#</a> 3 SpringBoot整合FastDFS实现文件上传下载测试</h2> <p>使用<code>javaApi</code>测试文件的上传。
<code>java</code>版本的<code>fastdfs-client</code>地址在：https://github.com/happyfish100/fastdfs-client-java，参考此工程编写测试用
例。</p> <h3 id="_3-1-环境搭建"><a href="#_3-1-环境搭建" class="header-anchor">#</a> 3.1 环境搭建</h3> <ul><li><p>新建maven工程</p></li> <li><p>添加依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.itcast.javaee<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0‐SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
 	   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/net.oschina.zcx7878/fastdfs-client-java --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.oschina.zcx7878<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastdfs-client-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.27.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>	
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></li> <li><p>resources目录下新建配置文件<code>fastdfs-client.properties</code></p></li></ul> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">fastdfs.connect_timeout_in_seconds</span> <span class="token punctuation">=</span> <span class="token attr-value">5</span>
<span class="token attr-name">fastdfs.network_timeout_in_seconds</span> <span class="token punctuation">=</span> <span class="token attr-value">30</span>
<span class="token attr-name">fastdfs.charset</span> <span class="token punctuation">=</span> <span class="token attr-value">UTF‐8</span>
<span class="token attr-name">fastdfs.http_anti_steal_token</span> <span class="token punctuation">=</span> <span class="token attr-value">false</span>
<span class="token attr-name">fastdfs.http_secret_key</span> <span class="token punctuation">=</span> <span class="token attr-value">FastDFS1234567890</span>
<span class="token attr-name">fastdfs.http_tracker_http_port</span> <span class="token punctuation">=</span> <span class="token attr-value">80</span>
<span class="token comment"># 根据实际情况调整</span>
<span class="token attr-name">fastdfs.tracker_servers</span> <span class="token punctuation">=</span> <span class="token attr-value">192.168.101.64:22122</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-2-文件上传、查询、下载"><a href="#_3-2-文件上传、查询、下载" class="header-anchor">#</a> 3.2 文件上传、查询、下载</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 文件上传
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">fileUpload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;java.version=&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 加载配置文件</span>
            <span class="token comment">//ClientGlobal.init(conf_filename);</span>
            <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span><span class="token function">initByProperties</span><span class="token punctuation">(</span><span class="token string">&quot;fastdfs-client.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;network_timeout=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_network_timeout <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_charset<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//创建tracker客户端</span>
            <span class="token class-name">TrackerClient</span> tracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StorageServer</span> storageServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token comment">//定义一个storage客户端</span>
            <span class="token class-name">StorageClient1</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StorageClient1</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> storageServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//文件元信息</span>
            <span class="token class-name">NameValuePair</span><span class="token punctuation">[</span><span class="token punctuation">]</span> metaList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameValuePair</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            metaList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameValuePair</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C:\\Users\\hspcadmin\\Desktop\\cat.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//执行上传</span>
            <span class="token class-name">String</span> fileId <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">upload_file1</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\Users\\hspcadmin\\Desktop\\cat.jpg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jpg&quot;</span><span class="token punctuation">,</span> metaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;upload success. file id is: &quot;</span> <span class="token operator">+</span> fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//关闭tracker服务</span>
            trackerServer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查询文件
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;java.version=&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 加载配置文件</span>
            <span class="token comment">//ClientGlobal.init(conf_filename);</span>
            <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span><span class="token function">initByProperties</span><span class="token punctuation">(</span><span class="token string">&quot;fastdfs-client.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;network_timeout=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_network_timeout <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_charset<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//创建tracker客户端</span>
            <span class="token class-name">TrackerClient</span> tracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StorageServer</span> storageServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token comment">//定义一个storage客户端</span>
            <span class="token class-name">StorageClient1</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StorageClient1</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> storageServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//查询文件</span>
            <span class="token class-name">FileInfo</span> fileInfo <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">query_file_info</span><span class="token punctuation">(</span><span class="token string">&quot;group1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;M00/00/00/wKjRgF3PSxiAHuHtAAFl33KnvNs253.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FileInfo</span> fileInfo1 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">query_file_info1</span><span class="token punctuation">(</span><span class="token string">&quot;group1/M00/00/00/wKjRgF3PSxiAHuHtAAFl33KnvNs253.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fileInfo1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//查询文件元信息</span>
            <span class="token class-name">NameValuePair</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileInfos <span class="token operator">=</span>  client<span class="token punctuation">.</span><span class="token function">get_metadata1</span><span class="token punctuation">(</span><span class="token string">&quot;group1/M00/00/00/wKjRgF3PSxiAHuHtAAFl33KnvNs253.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fileInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//关闭tracker服务</span>
            trackerServer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 文件下载
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fileDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 加载配置文件</span>
            <span class="token comment">//ClientGlobal.init(conf_filename);</span>
            <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span><span class="token function">initByProperties</span><span class="token punctuation">(</span><span class="token string">&quot;fastdfs-client.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;network_timeout=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_network_timeout <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;charset=&quot;</span> <span class="token operator">+</span> <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span>g_charset<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//创建tracker客户端</span>
            <span class="token class-name">TrackerClient</span> tracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> tracker<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StorageServer</span> storageServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token comment">//定义一个storage客户端</span>
            <span class="token class-name">StorageClient1</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StorageClient1</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> storageServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//下载文件</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileBytes <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">download_file1</span><span class="token punctuation">(</span><span class="token string">&quot;group1/M00/00/00/wKjRgF3PSxiAHuHtAAFl33KnvNs253.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:/chenyn.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FileOutputStream</span>  fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//关闭tracker服务</span>
            trackerServer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>1.如果有发生socker连接超时，注意查看linux机器的防火墙是否关闭</p> <p>2.如果发现上传文件之后，文件目录下有-m，-big文件等，这些文件是上传文件的元数据</p></div> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 或者端口是否开放</span>
vi /etc/sysconfig/iptables
<span class="token comment"># -A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT </span>
<span class="token comment"># 查看开放的端口数量</span>
service iptables status

<span class="token comment"># 查看元数据文件, 是 参数author,height,width的键值对</span>
vi test.png.m 

<span class="token comment"># 关闭元数据上传</span>
<span class="token comment"># 在调用client.upload_file()时，meta_list入参传null即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_4-文件服务案例"><a href="#_4-文件服务案例" class="header-anchor">#</a> 4 文件服务案例</h2> <h3 id="_4-1-需求"><a href="#_4-1-需求" class="header-anchor">#</a> 4.1 需求</h3> <p><img src="/image/fastdfs3.jpg" alt=""></p> <ul><li><p>上传页面上传图片到<code>fastDFS</code>文件系统。</p> <ul><li>进入上传页面，点击上传图片，选择本地图片</li> <li>选择本地图片后，进行上传，前端浏览器会通过<code>http</code>调用文件管理服务的文件上传接口进行上传</li> <li>文件管理服务通过<code>socket</code>请求<code>FastDFS</code>文件系统的上传图片，最终图片保存在<code>FastDFS</code>文件系统中的<code>storage server</code>中。</li></ul></li> <li><p>浏览上传的图片</p> <ul><li><p>进入视频下载页面</p></li> <li><p>前端浏览器通过图片地址请求图片服务器代理<code>nginx</code></p></li> <li><p>图片服务器代理根据负载情况将图片浏览请求转发到一台<code>storage server</code></p></li> <li><p><code>storage server</code>找到图片后通过<code>nginx</code>将图片响应给网友</p></li></ul></li></ul> <h3 id="_4-2-安装-fastdfs、nginx"><a href="#_4-2-安装-fastdfs、nginx" class="header-anchor">#</a> 4.2 安装 FastDFS、Nginx</h3> <h4 id="_4-2-1-安装fastdfs"><a href="#_4-2-1-安装fastdfs" class="header-anchor">#</a> 4.2.1 安装FastDFS</h4> <p>参上</p> <h4 id="_4-2-2-安装nginx"><a href="#_4-2-2-安装nginx" class="header-anchor">#</a> 4.2.2 安装Nginx</h4> <p>首先参考<a href="/dev/nginx/nginxstudy">nginx基础入门</a>，了解和搭建<code>nginx</code>服务器</p> <h4 id="_4-2-3-安装-fastdfs-nginx-module"><a href="#_4-2-3-安装-fastdfs-nginx-module" class="header-anchor">#</a> 4.2.3 安装 FastDFS-nginx-module</h4> <p>本文使用的是 <code>FastDFS-nginx-module_v1.16.tar.gz</code></p> <p>参考<code>github</code>地址：https://github.com/happyfish100/fastdfs-nginx-module</p> <p><strong>注意：要先关闭所有的<code>nginx</code>进程，再进行下面的步骤</strong></p> <ul><li><p>调整 <code>fastdfs-nginx-module</code>配置</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 调整 mod_fastdfs.conf配置 </span>
<span class="token comment"># 进入fastdfs-nginx-module解压目录</span>
cd /home/chenyn/fastdfs/fastdfs-nginx-module/src
<span class="token comment"># 复制mod_fastdfs.conf复制到/etc/fdfs/里面</span>
cp mod_fastdfs.conf /etc/fdfs/
<span class="token comment"># 调整mod_fastdfs.conf配置，根据实际情况调整路径</span>
<span class="token comment"># 更改 base_path=/home/chenyn/fastdfs/FastDFS</span>
<span class="token comment"># 更改 tracker_server=192.168.209.128:22122</span>
<span class="token comment"># 更改 store_path0=/home/chenyn/fastdfs/FastDFS/storage</span>

<span class="token comment"># 调整fastdfs-nginx-module的config文件 </span>
 vi  config 
<span class="token comment">#（这一步很重要，很重要，很重要（重要的事情说三遍） </span>
<span class="token comment"># CORE_INCS=&quot;$CORE_INCS /usr/local/include/fastdfs /usr/local/include/fastcommon/&quot; --删除local</span>
<span class="token comment"># CORE_LIBS=&quot;$CORE_LIBS -L/usr/local/lib -lfastcommon -lfdfsclient&quot; --删除local</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>重新编译nginx</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 进入解压的nginx目录（根据个人情况调整目录结构）</span>
cd /home/chenyn/nginx/nginx-<span class="token number">1.17.5</span>

<span class="token comment"># 配置FastDFS-nginx-module 到nginx中</span>
<span class="token comment"># 创建临时目录 </span>
mkdir -p /var/temp/nginx 
<span class="token comment"># 用下面的命令</span>
./configure \
    --add-module=/home/chenyn/fastdfs/fastdfs-nginx-module/src
<span class="token comment"># (/home/chenyn/fastdfs/fastdfs-nginx-module/src根据自己的文件目录来配)</span>

<span class="token comment"># 重新编译</span>
make
make install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ul> <h4 id="_4-2-4-配置nginx"><a href="#_4-2-4-配置nginx" class="header-anchor">#</a> 4.2.4 配置nginx</h4> <ul><li><p>只有一个<code>group</code>时，最简单的配置：当<code>mod_fastdfs.conf</code> 配置文件中只有一个<code>group1</code>, 且配置了<code>url_have_group_name = false</code>时，即访问地址不使用分组名称，那么只需在<code>nginx</code>的配置文件中增加以下配置即可:（不推荐）</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 进入nginx配置目录</span>
cd /usr/local/nginx/conf

<span class="token comment">#在nginx.conf里面的server{里面添加location /M00……}，添加下面的几行：</span>
location /M00 {
      root /home/chenyn/fastdfs/FastDFS/storage/data;
          ngx_fastdfs_module;
<span class="token punctuation">}</span>

<span class="token comment">#配置负载均衡</span>
<span class="token comment">#storage群group1组</span>
upstream storage_server_group1{
    	server <span class="token number">192.168.101.5</span>:<span class="token number">80</span> weight=<span class="token number">10</span>;
		server <span class="token number">192.168.101.6</span>:<span class="token number">80</span> weight=<span class="token number">10</span>;
    <span class="token punctuation">}</span>
<span class="token comment">#storage群group2组</span>
upstream storage_server_group2{
    	server <span class="token number">192.168.101.7</span>:<span class="token number">80</span> weight=<span class="token number">10</span>;
		server <span class="token number">192.168.101.8</span>:<span class="token number">80</span> weight=<span class="token number">10</span>;
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>多个<code>group</code>配置，当配置多个组，且<code>mod_fastdfs.conf</code>里面指定了<code>url_have_group_name= true</code> 时，配置方式:（建议即使用的是单个<code>group</code>，也按该方法配置）</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code> location ~  /<span class="token function">group</span><span class="token punctuation">(</span>[<span class="token number">0</span>-<span class="token number">9</span>]<span class="token punctuation">)</span> /M00 {
        root /home/chenyn/fastdfs/FastDFS/storage/data;
        ngx_fastdfs_module;
  <span class="token punctuation">}</span>
  <span class="token comment"># 比如:在group1上的 nginx 的nginx.conf 配置是</span>
  location  /group1/M00 {
        root /home/chenyn/fastdfs/FastDFS/storage/data;
        ngx_fastdfs_module;
  <span class="token punctuation">}</span>
  <span class="token comment"># 比如:在group2上的 nginx 的nginx.conf 配置是</span>
  location   /group2/M00 {
        root /home/chenyn/fastdfs/FastDFS/storage/data;
        ngx_fastdfs_module;
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>创建软连接</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 根据实际存储位置调整路径</span>
<span class="token comment"># 创建软连接的目的是为了将M00虚拟路径转化一下</span>
ln -s /home/chenyn/fastdfs/FastDFS/storage/data /home/chenyn/fastdfs/FastDFS/storage/data/M00
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>调整<code>FastDFS</code>配置</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 进入 FastDFS解压目录</span>
cd /home/chenyn/fastdfs/FastDFS/conf
<span class="token comment"># 移动配置文件</span>
cp  http.conf   /etc/fdfs/
cp  mime.types  /etc/fdfs/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>启动<code>FastDFS</code>、<code>nginx</code></p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>
<span class="token comment"># 启动Tracker</span>
/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart

<span class="token comment"># 启动Storage</span>
/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart

<span class="token comment"># 启动nginx</span>
cd /usr/local/nginx/sbin
./nginx -s restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul> <h3 id="_4-3-通过http访问fastdfs图片"><a href="#_4-3-通过http访问fastdfs图片" class="header-anchor">#</a> 4.3 通过<code>HTTP</code>访问<code>FastDFS</code>图片</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>http://192.168.209.128/group1/M00/00/00/wKjRgF3PSxiAHuHtAAFl33KnvNs253.jpg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果可以正常查看或者下载，恭喜配置成功😙</p> <p>如果失败，可以仔细查看一下上面的命令和配置，注意命令尽量不要复制，可能会有问题☺️</p> <h3 id="_4-4-安装-fastdht实现文件去重处理"><a href="#_4-4-安装-fastdht实现文件去重处理" class="header-anchor">#</a> 4.4 安装 <code>FastDHT</code>实现文件去重处理</h3> <p><code>FastDHT</code>是一个高性能的分布式哈希系统，它是基于键值对存储的，而且它需要依赖于<code>Berkeley DB</code>作为数据存储的媒介，同时需要依赖于<code>libfastcommon</code>。</p> <p><code>FastDHT</code>集群由一个或者多个组<code>group</code>组成，同组服务器上存储的数据是相同的，数据同步只在组的服务器之间进行；组内各个服务是对等的，对数据进行存取时，可以根据 <code>key</code>的<code>hash</code>值来决定使用哪台机器。</p> <h4 id="_4-4-1-安装berkeley-db"><a href="#_4-4-1-安装berkeley-db" class="header-anchor">#</a> 4.4.1 安装<code>Berkeley DB</code></h4> <p>在安装<code>FastDHT</code>之前，需要首先安装<code>Berkeley DB</code>，也需要安装<code>libfastcommon</code>，不过这安装<code>FastDFS</code>时已经安装了<code>libfastcommon</code>，所以这里省略。</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment"># 下载 berkeley-db</span>
cd /home/chenyn/fastdfs
wget http://download.oracle.com/berkeley-db/db-<span class="token number">4.7.25</span>.tar.gz
<span class="token comment"># 解压</span>
tar -zxvf db-<span class="token number">4.7.25</span>.tar.gz
<span class="token comment"># 进入解压目录</span>
cd db-<span class="token number">4.7.25</span>/build_unix
<span class="token comment"># 验证安装环境（安装到了/usr目录下）</span>
sudo ../dist/configure --prefix=/usr
<span class="token comment"># 编译，从Makefile中读取指令，然后编译</span>
sudo make
<span class="token comment"># 安装，从Makefile中读取指令，安装到指定位置</span>
sudo make install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_4-4-2-安装fastdht"><a href="#_4-4-2-安装fastdht" class="header-anchor">#</a> 4.4.2 安装FastDHT</h4> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>cd /home/chenyn/fastdfs
<span class="token comment"># wget下载FastDHT安装包 （可以根据实际情况选择版本）</span>
wget http://sourceforge.net/projects/fastdht/files/FastDHT%20server%20and%20php%20ext/FastDHT%20Server%20Source%20Code%20V2.<span class="token number">01</span>/FastDHT_v2.<span class="token number">01</span>.tar.gz
<span class="token comment"># 解压</span>
tar –zxvf FastDHT_v2.<span class="token number">01</span>.tar.gz
cd FastDHT
<span class="token comment"># 编译之前需要修改make.sh</span>
vi make.sh
<span class="token comment"># 文件中的 “CFLAGS='-Wall -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE'” 修改为 “CFLAGS='-Wall -D_FILE_OFFSET_BITS=64 -D_GNU_SOURCE -I/usr/include/ -L/usr/lib/'” （-I/usr/include/ -L/usr/lib/）这里对应上面Berkeley的安装目录</span>
sudo ./make.sh
sudo ./make.sh install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_4-4-3-配置fastdht"><a href="#_4-4-3-配置fastdht" class="header-anchor">#</a> 4.4.3 配置FastDHT</h4> <p>先确认目录<code>/data/fastdht/</code>已创建，如果没有创建，执行以下命令创建目录：</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>mkdir -p /data/fastdht
<span class="token comment"># 配置fdht_client.conf文件</span>
cd /etc/fdht
vi fdht_client.conf
<span class="token comment"># 修改下面配置</span>
base_path=/data/fastdht
keep_alive=<span class="token number">1</span>
<span class="token comment">#include /etc/fdht/fdht_servers.conf   ---该配置不是注释，一定要加!!!</span>

<span class="token comment"># 配置fdht_servers.conf</span>
vi fdht_servers.conf
<span class="token comment"># 根据fdht的机器数量调整，下面为1台参考配置</span>
group_count=<span class="token number">1</span>
group0=<span class="token number">192.168.209.128</span>;<span class="token number">11411</span>

<span class="token comment"># 配置fdhtd.conf</span>
vi fdhtd.conf
port=<span class="token number">11411</span>
bash_path=/data/fastdht
cache_size=32MB
<span class="token comment">#include /etc/fdht/fdht_servers.conf ---该配置不是注释，一定要加!!!</span>

<span class="token comment"># 配置fastdfs的storage.conf</span>
vi /etc/fdfs/storage.conf
<span class="token comment"># 是否检查上传文件已经存在。如果已经存在，则建立一个索引链接以节省空间</span>
check_file_duplicate=<span class="token number">1</span>
<span class="token comment"># check_file_duplicate=1时，FastDHT的命名空间</span>
key_namespace=FastDFS
<span class="token comment"># 长连接配置选项，0为短连接 1为长连接</span>
keep_alive=<span class="token number">1</span>
<span class="token comment">#include /etc/fdht/fdht_servers.conf ---该配置不是注释，一定要加!!!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_4-4-4-启动fastdht"><a href="#_4-4-4-启动fastdht" class="header-anchor">#</a> 4.4.4 启动<code>FastDHT</code></h4> <p>启动前关闭防火墙，或者开启端口（11411）</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code>vi /etc/sysconfig/iptables
添加如下端口行：
<span class="token comment"># FastDHT Port</span>
-A INPUT -m state --state NEW -m tcp -p tcp --dport <span class="token number">11411</span> -j ACCEPT
<span class="token comment"># 修改之后重启防火墙：</span>
 service iptables restart
<span class="token comment"># 之后，就可以直接启动FastDHT了。</span>
 /usr/local/bin/fdhtd /etc/fdht/fdhtd.conf
<span class="token comment"># 可以监控11411端口号的使用情况，确认是否启动成功。</span>
 netstat –unltp | grep <span class="token number">11411</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_4-4-5-上传测试"><a href="#_4-4-5-上传测试" class="header-anchor">#</a> 4.4.5 上传测试</h4> <p>使用<code>3.2节</code>的上传方法上传重复文件，进入<code>/M00/00/00</code> 查看</p> <p><img src="/image/fdht.jpg" alt=""></p> <p>出现上图，软连接指向，恭喜~~😃</p> <h3 id="_4-5-常见错误"><a href="#_4-5-常见错误" class="header-anchor">#</a> 4.5 常见错误</h3> <ul><li><p>配置<code>FastDFS-nginx-moudle</code>发生<code>nginx</code>访问不了的情况，查看<code>nginx</code>启动日志，按错误信息排查</p> <div class="language-cmake line-numbers-mode"><pre class="language-cmake"><code><span class="token comment">#Nginx 服务器启动失败的，错误信息：trunk_shared.c, line: 177, &quot;Permission denied&quot; can't be accessed</span>
只需修改Nginx配置文件，输入命令 “ vi /usr/local/nginx/conf/nginx.conf ”,在配置文件的开头加入 “ user root; ” 即可

<span class="token comment"># nginx日志报错ERROR - file: ../common/fdfs_global.c, line: 52, the format of filename</span>
vi /etc/fdfs/mod_fastdfs.conf
将  url_have_group_name=false 改为 url_have_group_name=true

<span class="token comment"># 其他常见问题,或者根据日志错误信息找百度</span>
http://www.mamicode.com/info-detail-<span class="token number">1992668</span>.html

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul> <h1 id="启动fdht报错：error-while-loading-shared-libraries-xxx-so-0-cannot-open-shared-object-file-no-such-file-or-directory"><a href="#启动fdht报错：error-while-loading-shared-libraries-xxx-so-0-cannot-open-shared-object-file-no-such-file-or-directory" class="header-anchor">#</a> 启动fdht报错：error while loading shared libraries: xxx.so.0:cannot open shared object file: No such file or directory</h1> <p>出现这类错误表示，系统不知道xxx.so放在哪个目录下，这时候就要在/etc/ld.so.conf中加入xxx.so所在的目录。
一般而言，有很多的so会存放在/usr/local/lib这个目录底下，去这个目录底下找，果然发现自己所需要的.so文件。
所以，在/etc/ld.so.conf中加入/usr/local/lib这一行，保存之后，再运行：/sbin/ldconfig –v 更新一下配置即可。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/28/2020, 7:36:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/master/01.dev/11.nginx/nginxstudy.html" class="prev">
        nginx(代理服务器)
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/master/assets/js/app.2082b23a.js" defer></script><script src="/master/assets/js/2.926fc16b.js" defer></script><script src="/master/assets/js/6.5babb80d.js" defer></script>
  </body>
</html>
